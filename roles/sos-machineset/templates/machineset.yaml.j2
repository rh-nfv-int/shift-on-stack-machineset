apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  labels:
    machine.openshift.io/cluster-api-cluster: {{ infrastructure_id }}
    machine.openshift.io/cluster-api-machine-role: {{ node_role }}
    machine.openshift.io/cluster-api-machine-type: {{ node_role }}
  name: {{ infrastructure_id }}-{{ node_role }}
  namespace: openshift-machine-api
spec:
  replicas: {{ number_of_replicas }}
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: {{ infrastructure_id }}
      machine.openshift.io/cluster-api-machineset: {{ infrastructure_id }}-{{ node_role }}
  template:
    metadata:
      labels:
        machine.openshift.io/cluster-api-cluster: {{ infrastructure_id }}
        machine.openshift.io/cluster-api-machine-role: {{ node_role }}
        machine.openshift.io/cluster-api-machine-type: {{ node_role }}
        machine.openshift.io/cluster-api-machineset: {{ infrastructure_id }}-{{ node_role }}
    spec:
      metadata:
      providerSpec:
        value:
          apiVersion: openstackproviderconfig.openshift.io/v1alpha1
          cloudName: openstack
          cloudsSecret:
            name: openstack-cloud-credentials
            namespace: openshift-machine-api
          flavor: {{ nova_flavor }}
          image: {{ glance_image_name_or_location }}
          kind: OpenstackProviderSpec
          networks:
            - subnets:
              - UUID: {{ machines_subnet_UUID }}
          ports:
{% for item in additional_networks %}
            - networkID: {{ item.network_UUID }}
              nameSuffix: {{ item.name_suffix }}
              fixedIPs:
                - subnetID: {{ item.subnet_UUID }}
              vnicType: {{ item.vnic_type }}
              portSecurity: false
{% endfor %}
          primarySubnet: {{ machines_subnet_UUID }}
          securityGroups:
          - filter: {}
            name: {{ infrastructure_id }}-{{ node_role }}
          serverMetadata:
            name: {{ infrastructure_id }}-{{ node_role }}
            openshiftClusterID: {{ infrastructure_id }}
          tags:
          - openshiftClusterID={{ infrastructure_id }}
          trunk: true
          userDataSecret:
            name: worker-user-data
          configDrive: true
